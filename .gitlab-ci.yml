services:

before_script:
  - php -v

after_script:

stages:
  - build
  - deploy

job1:
  stage: build
  script:
    - pwd
    - composer install
    - docker/docker.sh private:travis:before_script
    - php vendor/code-checker/code-checker -l --short-arrays --strict-types -d app
    - php vendor/code-checker/code-checker -l --short-arrays --strict-types -d tests
    - cp app/config/config.local.dist.neon app/config/config.local.neon
    - rm -rf var/tempcli/cache
    - docker/docker.sh private:test-coding-style
    - echo "job1 succesfully completed!"
  tags:
    - php
staging:
  stage: deploy
  before_script:
    - echo "Deploy to staging server"
    - mkdir -p ~/.ssh
    - echo -e "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  script:
    - ssh ${SSH_DEV_SERVER} "cd /var/www/blockchain-explorer/ && git fetch origin && git reset --hard ${CI_COMMIT_SHA} && sudo rm -rf var/temp/cache/ && composer install"
  environment:
    name: staging
    url: https://explorer.citicash.loc
  only:
  - master
  tags:
  - citicash

# Cache libraries in between jobs
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
  - vendor/
